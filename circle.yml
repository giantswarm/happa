machine:
  services:
    - docker

dependencies:
  override:
    - |
      wget -q $(curl -sS -H "Authorization: token $RELEASE_TOKEN" https://api.github.com/repos/giantswarm/architect/releases/latest | grep browser_download_url | head -n 1 | cut -d '"' -f 4)
    - chmod +x ./architect
    - ./architect version

compile:
  override:
    - npm install
    - npm test
    - mkdir dist
    - grunt build
    - docker build -t registry.giantswarm.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 -f Dockerfile .

test:
  override:
    # Just a little smoke test. Starts the production container and checks
    # if a line of text from index.html is in there.
    - docker run -p 8000:8000 -d registry.giantswarm.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1
    - curl -k https://localhost:8000 | grep Happa # Grep returns non 0 exit code if it can't find the text, which fails the smoke test

deployment:
  master:
    branch: master
    commands:
      - ./architect deploy --resources-directory-path='./kubernetes/production'

  staging:
    branch: /.*/
    commands:
      - unset AWS_CA
      - unset AWS_CRT
      - unset AWS_KEY
      - ./architect deploy --resources-directory-path='./kubernetes/staging'
