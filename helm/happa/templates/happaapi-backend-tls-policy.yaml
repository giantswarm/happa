{{- if and .Values.happaapiRoute.enabled .Values.happaapiRoute.backendTLS .Values.happaapiRoute.backendTLS.enabled -}}
{{- $tls := .Values.happaapiRoute.backendTLS }}
{{- $route := .Values.happaapiRoute }}
---
apiVersion: gateway.networking.k8s.io/v1alpha3
kind: BackendTLSPolicy
metadata:
  name: {{ $route.name | default "happaapi" }}-backend-tls
  namespace: {{ $route.namespace | default "default" }}
  labels:
    {{- include "commonLabels" $ | nindent 4 }}
    app: {{ .Values.name }}
    {{- with $tls.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $tls.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  targetRefs:
    - group: ""
      kind: Service
      name: {{ $route.backend.name | default "kubernetes" }}
      {{- if $route.backend.portName }}
      sectionName: {{ $route.backend.portName }}
      {{- else if eq (toString ($route.backend.port | default 443)) "443" }}
      sectionName: https
      {{- end }}
  validation:
    {{- if $tls.validation.hostname }}
    hostname: {{ $tls.validation.hostname }}
    {{- else if eq ($route.backend.name | default "kubernetes") "kubernetes" }}
    hostname: kubernetes.default.svc.cluster.local
    {{- else }}
    hostname: {{ $route.backend.name | default "kubernetes" }}.default.svc.cluster.local
    {{- end }}
    {{- with $tls.validation.caCertificateRefs }}
    caCertificateRefs:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- if hasKey $tls.validation "wellKnownCACerts" }}
    wellKnownCACerts: {{ $tls.validation.wellKnownCACerts }}
    {{- end }}
{{- end }}

