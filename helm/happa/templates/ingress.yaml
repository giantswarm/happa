apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: {{ tpl .Values.resource.default.name  . }}
  namespace: {{ tpl .Values.resource.default.namespace  . }}
  labels:
    app:  {{ tpl .Values.resource.default.name  . }}
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    {{- if and (eq .Values.Installation.V1.Provider.Kind "aws") (.Values.Installation.V1.Security.RestrictAccess.GSAPI) }}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ template "whitelistCIDR" . }}
    {{- end }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options deny always;
spec:
  rules:
    # We want a hostname that ends up looking like
    # https://SHA.happa.g8s.codename.eu-central-1.aws.gigantic.io/
    # We have the SHA in the release name, so we take it from there.
  - host: {{ tpl .Values.resource.default.name  . | replace "happa-" "" | trunc 7 }}.{{ .Values.Installation.V1.GiantSwarm.Happa.Host }}
    http:
      paths:
      - backend:
          serviceName: {{ tpl .Values.resource.default.name  . }}
          servicePort: 8000
        path: /
  tls:
  - hosts:
    - {{ tpl .Values.resource.default.name  . }}-{{ .Values.Installation.V1.GiantSwarm.Happa.Host }}
    secretName: {{ tpl .Values.resource.default.name  . }}-tls
